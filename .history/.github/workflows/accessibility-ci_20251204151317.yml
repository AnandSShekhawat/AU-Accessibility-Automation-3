name: Automated Accessibility Scan

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  a11y-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install axe-core CLI and static server
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          npm install -g @axe-core/cli serve browser-driver-manager
          npx browser-driver-manager install chrome

      - name: Serve site locally
        run: |
          serve . -l 3000 &
          sleep 8

      - name: Run accessibility scan
        run: |
          echo "Running accessibility scan..."
          axe http://localhost:3000/before.html \
            --save a11y-report.json || echo "Scan completed with warnings"
          echo "Scan completed"
          jq 'length' a11y-report.json

      - name: Upload accessibility report
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: a11y-report.json

      - name: Create GitHub issues for each violation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Ensuring required labels exist..."
          gh label create "a11y-scan" --color "#B60205" >/dev/null 2>&1 || echo "Label a11y-scan already exists"
          gh label create "copilot:accessibility" --color "#0366D6" >/dev/null 2>&1 || echo "Label copilot:accessibility already exists"

          count=$(jq '.[0].violations | length' a11y-report.json)
          echo "Found $count accessibility violations"
          if [ "$count" -eq 0 ]; then
            echo "No accessibility issues found."
            exit 0
          fi

          jq -c '.[0].violations[]' a11y-report.json | while read -r violation; do
            rule=$(echo "$violation" | jq -r '.id // "Unknown rule"')
            desc=$(echo "$violation" | jq -r '.description // "No description available"')
            help=$(echo "$violation" | jq -r '.helpUrl // "No help URL"')
            snippet=$(echo "$violation" | jq -r '.nodes[0].html // "No snippet available"' | sed 's/`/"/g')

            title="Fix: ${rule} violation"
            body="### Accessibility Issue Detected \n\n"
            body+="**Rule:** \`${rule}\`\n\n"
            body+="**Description:**\n${desc}\n\n"
            body+="**Example Element:**\n\`\`\`html\n${snippet}\n\`\`\`\n\n"
            body+="WCAG Rule: ${help}\n"

            printf "%b\n" "$body" > issue.md

            gh issue create \
              --title "$title" \
              --body-file issue.md \
              --label "a11y-scan" \
              --label "copilot:accessibility" \
              || echo "Failed to create issue for ${rule}"
          done
